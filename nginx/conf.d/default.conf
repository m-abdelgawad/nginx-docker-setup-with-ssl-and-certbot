# Global DNS resolver for Docker's embedded DNS
resolver 127.0.0.11 valid=30s;

# This map is now used ONLY inside the main portfolio server block.
map $http_user_agent $is_unwanted_bot {
    default 0;
    ~*(gptbot) 1;
    # Add other unwanted bots here in the future
}

# ----------------------------------------------------------------------
# 1. CATCH-ALL DEFAULT SERVER (for unknown subdomains on HTTPS)
# ----------------------------------------------------------------------
# This block MUST come FIRST among the "listen 443" blocks.
# It will catch any SSL request that doesn't match another server_name.
server {
    listen 443 ssl default_server;
    http2 on;

    # A server_name is not strictly needed, but `_` is a common
    # convention for a non-matching "catch-all" name.
    server_name _;

    # Use your SSL snippets so it's a valid SSL server
    include /etc/nginx/conf.d/snippets/ssl_base.conf;

    # Immediately return a 404 for all requests
    location / {
        return 404;
    }
}

# ----------------------------------------------------------------------
# 1. Redirect everything on :80 to HTTPS
# ----------------------------------------------------------------------
server {
    listen 80;
    server_name automagicdeveloper.com www.automagicdeveloper.com
                admin.automagicdeveloper.com
#                 replicabot.automagicdeveloper.com
#                 aistoreassistant.automagicdeveloper.com
#                 lifehub.automagicdeveloper.com
#                 enjaz.automagicdeveloper.com
#                 myreads.automagicdeveloper.com
#                 polarity.automagicdeveloper.com
#                 clientnest.automagicdeveloper.com
                n8n.automagicdeveloper.com
#                 litellm.automagicdeveloper.com
                walletscraper.automagicdeveloper.com
                egypt-gold-tracker.automagicdeveloper.com;
    return 301 https://$host$request_uri;
}

# ----------------------------------------------------------------------
# 2. Automagic Developer Portfolio SPA (Public - Next.js)
# ----------------------------------------------------------------------
server {
    listen 443 ssl;
    http2  on;
    server_name automagicdeveloper.com www.automagicdeveloper.com;

    # Block unwanted bots at the server level
    if ($is_unwanted_bot) {
        return 444; # Silently drop the connection
    }

    # Docker service names
    set $fe portfolio-frontend-public-nextjs;
    set $api portfolio-backend;

    include /etc/nginx/conf.d/snippets/ssl_base.conf;
    include /etc/nginx/conf.d/snippets/performance.conf;

    # --- SEO/Sitemap Routes (MUST come before other locations) ---
    location = /robots.txt {
        proxy_pass http://$api:8000/robots.txt;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        add_header Cache-Control "public, max-age=86400";
    }

    location = /sitemap.xml {
        proxy_pass http://$api:8000/sitemap.xml;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        add_header Cache-Control "public, max-age=3600";
    }

    location ~ ^/(sitemap-.*\.xml)$ {
        proxy_pass http://$api:8000/$1;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        add_header Cache-Control "public, max-age=3600";
    }

    # Media files (served directly by Nginx from shared volume)
    location ^~ /media/ {
        root /var/www;
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
        try_files $uri =404;
    }

    # --- Next.js API Routes (MUST come before the general /api/ block) ---
    location /api/revalidate {
        proxy_pass http://$fe:3000;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # ---------- JSON API (FastAPI root_path=/api) ----------
    location ^~ /api/ {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://$api:8000;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_pass_request_headers on;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Original-User-Agent $http_user_agent;
        client_max_body_size 10M;
    }

    # ---------- Next.js App ROOT (handles all other traffic) ----------
    location / {
        proxy_pass http://$fe:3000;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Referer $http_referer;
        proxy_set_header Accept-Language $http_accept_language;
        proxy_set_header X-Is-Test $http_x_is_test;
    }
}
# ----------------------------------------------------------------------
# 3. Automagic Developer Portfolio SPA (Admin)
# ----------------------------------------------------------------------
server {
    listen 443 ssl;
    http2  on;
    server_name admin.automagicdeveloper.com;

    set $admin_fe portfolio-frontend-admin;

    include /etc/nginx/conf.d/snippets/ssl_base.conf;
    include /etc/nginx/conf.d/snippets/performance.conf;

    location / {
        proxy_pass http://$admin_fe:80;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_pass_request_headers on;
        proxy_set_header Authorization $http_authorization;
    }
}


# ----------------------------------------------------------------------
# 4. N8N
# ----------------------------------------------------------------------
server {
    listen 443 ssl;
    http2  on;
    server_name n8n.automagicdeveloper.com;

    set $app n8n;

    include /etc/nginx/conf.d/snippets/ssl_base.conf;
    include /etc/nginx/conf.d/snippets/performance.conf;

    location / {
        proxy_pass http://$app:5678;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# ----------------------------------------------------------------------
# 5. egypt-gold-tracker API
# ----------------------------------------------------------------------
server {
    listen 443 ssl;
    http2  on;
    server_name egypt-gold-tracker.automagicdeveloper.com;

    set $backend egy-gold-tracker-api;

    include /etc/nginx/conf.d/snippets/ssl_base.conf;
    include /etc/nginx/conf.d/snippets/performance.conf;

    location / {
        proxy_pass http://$backend:8000;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_pass_request_headers on;
        proxy_set_header Authorization $http_authorization;
    }
}

# ----------------------------------------------------------------------
# 6. wallet-scraper API
# ----------------------------------------------------------------------
server {
    listen 443 ssl;
    http2  on;
    server_name walletscraper.automagicdeveloper.com;

    set $backend walletscraper;

    include /etc/nginx/conf.d/snippets/ssl_base.conf;
    include /etc/nginx/conf.d/snippets/performance.conf;

    location / {
        proxy_pass http://$backend:8000;
        include /etc/nginx/conf.d/snippets/proxy_headers.conf;
        proxy_pass_request_headers on;
        proxy_set_header Authorization $http_authorization;
    }
}

