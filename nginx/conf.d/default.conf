resolver 127.0.0.11 valid=30s;

map $http_host $upstream_target {
    automagicdeveloper.com             automagic:8000;
    www.automagicdeveloper.com         automagic:8000;
    replicabot.automagicdeveloper.com  replicabot:8000;
    aistoreassistant.automagicdeveloper.com aistoreassistant-frontend:8000;
    lifehub.automagicdeveloper.com     lifehub:8000;
    enjaz.automagicdeveloper.com       enjaz:8000;
    myreads.automagicdeveloper.com     myreads-frontend:80;
}

# Force HTTP → HTTPS
server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
}

# ────────────────────────────────────────────────
# MyReads special routing: /api → backend
# ────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    server_name myreads.automagicdeveloper.com;

    include snippets/ssl_common.conf;
    include snippets/gzip.conf;
    include snippets/proxy_headers.conf;

    location /api/ {
        proxy_pass http://myreads-backend:8000;
    }

    location / {
        proxy_pass http://myreads-frontend:80;
    }
}

# ────────────────────────────────────────────────
# Generic rule for everything else
# ────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    server_name _;

    include snippets/ssl_common.conf;
    include snippets/gzip.conf;
    include snippets/proxy_headers.conf;

    location / {
        proxy_pass http://$upstream_target;
    }
}
