resolver 127.0.0.11 valid=30s;

# ────────────────────────────────
# 1.  Host  →  FRONTEND container
# ────────────────────────────────
map $http_host $frontend_target {
    # Monoliths
    automagicdeveloper.com               automagic:8000;
    www.automagicdeveloper.com           automagic:8000;
    replicabot.automagicdeveloper.com    replicabot:8000;
    enjaz.automagicdeveloper.com         enjaz:8000;
    lifehub.automagicdeveloper.com       lifehub:8000;

    # Split FE/BE
    myreads.automagicdeveloper.com       myreads-frontend:80;

    # Multi-service FE
    aistoreassistant.automagicdeveloper.com aistoreassistant-frontend:8000;
}

# ────────────────────────────────
# 2.  Host  →  BACKEND container
#     (If no separate back-end, repeat the same target as above)
# ────────────────────────────────
map $http_host $backend_target {
    # Monoliths (same as FE)
    automagicdeveloper.com               automagic:8000;
    www.automagicdeveloper.com           automagic:8000;
    replicabot.automagicdeveloper.com    replicabot:8000;
    enjaz.automagicdeveloper.com         enjaz:8000;
    lifehub.automagicdeveloper.com       lifehub:8000;

    # Split FE/BE
    myreads.automagicdeveloper.com       myreads-backend:8000;

    # Multi-service main API (catch-all)
    aistoreassistant.automagicdeveloper.com aistoreassistant-backend:8000;
}

# ────────────────────────────────
# 3.  HTTP  →  HTTPS redirect
# ────────────────────────────────
server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
}

# ────────────────────────────────
# 4.  Generic HTTPS server
# ────────────────────────────────
server {
    listen 443 ssl http2;
    server_name _;

    include snippets/ssl_common.conf;
    include snippets/gzip.conf;
    include snippets/proxy_headers.conf;

    # ----- Per-domain API split -----
    location ^~ /api/ {
        proxy_pass http://$backend_target;
    }

    # ----- Everything else ----------
    location / {
        proxy_pass http://$frontend_target;
    }

    # ----- Pull in extra rules for hosts that need them -----
    include optional_hosts/*.conf;
}
