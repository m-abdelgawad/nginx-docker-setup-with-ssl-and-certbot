# ----------------------------------------------------------------------
# /etc/nginx/conf.d/default.conf
# ----------------------------------------------------------------------
resolver 127.0.0.11 valid=30s;

# 1) Map the requested host to a Docker-DNS upstream (add new lines here)
map $http_host $upstream_target {
    automagicdeveloper.com             automagic:8000;
    www.automagicdeveloper.com         automagic:8000;
    replicabot.automagicdeveloper.com  replicabot:8000;
    aistoreassistant.automagicdeveloper.com aistoreassistant-frontend:8000;
    lifehub.automagicdeveloper.com     lifehub:8000;
    enjaz.automagicdeveloper.com       enjaz:8000;
    myreads.automagicdeveloper.com     myreads-frontend:80;
}

# 2) Force HTTP → HTTPS
server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
}

# 3) Single HTTPS vhost for everything
server {
    listen 443 ssl http2;
    server_name _;

    include snippets/ssl_common.conf;     # TLS + HSTS
    include snippets/gzip.conf;           # compression
    include snippets/proxy_headers.conf;  # X-Forwarded-* headers + buffers

    # Generic rule – 99 % of apps
    location / {
        proxy_pass http://$upstream_target;
    }

    # Special rule – MyReads backend
    location ^~ /api/ {
        proxy_pass http://myreads-backend:8000;
    }
}
